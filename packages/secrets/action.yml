name: 'Get secrets from Azure KeyVault'
description: 'Get secrets from Azure KeyVault'
inputs:
  keyvault-key:
    required: true
    description: The name of the KeyVault
  azure-credentials:
    required: true
    description: Azure Credentials for login
  github-organization:
    required: true
    description: Name of the github organization that is used to locate the secrets mapping file
  configurations-repository:
    required: true
    description: Name of the repository for mulesoft configurations
runs:
  using: "composite"
  steps:

    - name: Get global configuration
      shell: bash
      env:
        SECRET_MAP_FILE: global.yml
      run: |
        echo
        echo "*********************************************"
        echo "Get global configuration"
        echo "*********************************************"

        echo "github_configurations_accesstoken: $github_configurations_accesstoken"

        # Get the configuration file from the github repository
        urlconfigurationfile="https://raw.githubusercontent.com/${{ inputs.github-organization }}/${{ inputs.configurations-repository }}/main/$SECRET_MAP_FILE"
        echo "Getting the secrets mapping file: $urlconfigurationfile"
        initialsecretconfiguration=$(curl -sH "Authorization: token $github_configurations_accesstoken" $urlconfigurationfile)

        # Verify if configuration file was found
        if [[ $configurationdata != *"Not Found"* ]]; then
          echo "A configuration file for the service was found"
          
          # Write the configuration file in the filesystem
          echo "$initialsecretconfiguration" > global.yml
        else
          echo "No configuration file found, returning an empty file"
          touch global.yml
        fi

    - name: Import vars example
      uses: zlatko-ms/varfiletoenv@v3
      with:
        paths: global.yaml
