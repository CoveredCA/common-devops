##########################################################################
# Mulesoft CICD Pipeline - Deploy Mulesoft Application
##########################################################################

name: Deployment
on:
  workflow_call:

env:
  CONFIGURATIONS_REPOSITORY: common-configurations
  GLOBAL_CONFIGURATION: _global.yml
  SECRETS_AZURE_KEYVAULT: CoveredCA-KV-Mulesoft
  MESSAGE_SERVICE_SUCCESS_DEPLOYED: "The service was successfully deployed"
  MESSAGE_SERVICE_INTERNAL_ERROR: "There was an internal error in the deployment process"

  MESSAGE_SERVICE_NOT_DEPLOYED: "The service couldn't be deployed"
  MESSAGE_SERVICE_BAT_SUCCESS: "The BAT tests run successfully"
  MESSAGE_SERVICE_NO_BAT: "There aren't any BAT tests"
  MESSAGE_SERVICE_BAT_FAILURE: "BAT testig with failures"

jobs:

  CloudHub:
    name: CloudHub
    runs-on: ubuntu-latest
    steps:

      - name: Get token from Github App
        id: app-token
        uses: CoveredCA/common-devops/packages/app-token@main
        with:
          client-id: ${{ secrets.MULESOFT_GITHUBAPP_CLIENTID}}
          privatekey: ${{ secrets.MULESOFT_GITHUBAPP_PRIVATEKEY }}

      - name: Get secrets from Azure Key Vault
        id: secrets
        uses: CoveredCA/common-devops/packages/secrets-azure@main
        with:
          keyvault-key: ${{ env.SECRETS_AZURE_KEYVAULT}}
          azure-credentials: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Get service configuration
        uses: CoveredCA/common-devops/packages/configuration-service@main

      - name: Get jar file
        uses: dsaltares/fetch-gh-release-asset@master
        with:
          repo: '${{ github.repository }}'
          version: 'tags/${{ env.deployment_version }}'
          regex: false
          file: "${{ env.service_artifact }}-${{ env.deployment_version }}-${{ env.configuration_apptype }}.jar"
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Debug show root files
        id: debug-show-root-files
        shell: bash
        run: |
          echo " "
          echo "***************************************"
          echo "Debug show root files"
          echo "***************************************"
          echo " "
          ls -l

      #- name: Deploy the service in Cloudhub1 
      #  id: deployment-ch1
      #  uses: CoveredCA/common-devops/packages/process-cloudhub1@main

      - name: Create badge for deployment
        uses: CoveredCA/common-devops/packages/badge@main
        with:
          label: '${{ env.deployment_environment }} version'
          status: '${{ env.deployment_version }}'
          color: '535597'
          file: ${{ env.service_name }}-${{ env.deployment_environment }}.svg
          folder: ${{ env.service_name }}

      - name: Execute Mulesoft BAT
        id: bat-testing
        uses: CoveredCA/common-devops/packages/process-bat@main
        with:
          deployment-env: ${{ env.deployment_environment }} 