name: Update Common Imports

on:
  workflow_call:

env:
  CONFIGURATIONS_REPOSITORY: common-configurations
  GLOBAL_CONFIGURATION: _global.yml
  SECRETS_AZURE_KEYVAULT: CoveredCA-KV-Mulesoft

jobs:
  updateImports:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      checks: write
      issues: write
      pull-requests: write
      actions: write

    steps:

      - name: Get token from Github App
        id: app-token
        uses: CoveredCA/common-devops/packages/app-token@main
        with:
          client-id: ${{ secrets.MULESOFT_GITHUBAPP_CLIENTID }}
          privatekey: ${{ secrets.MULESOFT_GITHUBAPP_PRIVATEKEY }}

      - name: Get secrets from Azure Key Vault
        id: secrets
        uses: CoveredCA/common-devops/packages/secrets-azure@main
        with:
          keyvault-key: ${{ env.SECRETS_AZURE_KEYVAULT}}
          azure-credentials: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Install XML Parser
        shell: bash
        run: |
          echo "  Install XMLStarlet in Ubuntu"
          sudo apt-get install xmlstarlet --fix-missing
          echo " "
          echo "  xmlstarlet --version"
          xmlstarlet --version
          echo " "

      - name: Acquire Common-Parent-Pom Latest Version
        shell: bash
        run: |
          echo " "
          echo "***************************************"
          echo "Acquiring Common-Parent-Pom latest version"
          echo "***************************************"
          echo " "
          urlconfigurationfile="https://raw.githubusercontent.com/CoveredCA/common-parent-pom/main/pom.xml"
          echo "  URL of file: $urlconfigurationfile"
          configurationdata=$(curl -sH "Authorization: token $github_automationbot_token" $urlconfigurationfile)
          echo " "
          echo $configurationdata > parent-pom.xml
          echo "  Parse parent-pom.xml"
          PARENT_POM_VERSION=$( xmlstarlet sel -N x=http://maven.apache.org/POM/4.0.0 -t -v "/x:project/x:version" parent-pom.xml )
          echo " "
          echo "  parent_pom_version: $PARENT_POM_VERSION"
          echo " "
          echo "PARENT_POM_VERSION=$PARENT_POM_VERSION" >> $GITHUB_ENV
          echo " "
          #============================================================#

      - name: Acquire Common-Core Latest Version
        shell: bash
        run: |
          echo " "
          echo "***************************************"
          echo "Acquiring Common-Core latest version"
          echo "***************************************"
          COMMON_CORE_VERSION_COMMAND="anypoint-cli-v4 exchange:asset:list \
          --client_id $cicd_connectedapp_clientid \
          --client_secret $cicd_connectedapp_secret \
          --organizationId 83ce023f-20c2-40a9-abdd-efdab38b2bcf \
          --host gov.anypoint.mulesoft.com \
          --output json \
          common-core"
          echo "command used: $COMMON_CORE_VERSION_COMMAND"
          common_core_version=$($COMMON_CORE_VERSION_COMMAND | jq -r 'sort_by(.version) | map(.version) | last(.[])')
          echo " "
          echo "Common-Core version: $common_core_version"
          echo " "
          echo "ma_common_core_version=$common_core_version" >> $GITHUB_ENV
          echo " "

      - name: Show data
        shell: bash
        run: |
            echo "Fetch common-parent-pom and common-core versions"
            echo " "
            echo "**************************************"
            echo "Common Core"
            echo "**************************************"
            echo " "
            echo "Common Core Version"
            echo " "
            echo "$common_core_version"

            echo " "
            echo "**************************************"
            echo "Common Parent Pom"
            echo "**************************************"
            echo " "
            parent_pom_version=$(cat common-parent-pom/pom.xml)
            echo "Common Parent POM:"
            echo " "
            echo "$PARENT_POM_VERSION"

      - name: Get List of Repositories
        id: repo-list
        shell: bash
        run: |
          repos=$(gh repo list CoveredCA --topic mulesoft --topic app | awk '{print $1}')

          # Loop through each repository
          for repo in "${repos[@]}"; do
            echo "Processing repository: $repo"

            # Fetch pom.xml content from the repository
            pom_content=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" https://raw.githubusercontent.com/CoveredCA/$repo/refs/heads/main/pom.xml)

            # Extract versions from the repository's pom.xml
            app_version=$(echo "$pom_content" | xmlstarlet sel -N x=http://maven.apache.org/POM/4.0.0 -t -v "/x:project/x:version")
            parent_pom_version_app=$(echo "$pom_content" | xmlstarlet sel -N x=http://maven.apache.org/POM/4.0.0 -t -v "/x:project/x:parent/x:version")
            common_core_version_app=$(echo "$pom_content" | xmlstarlet sel -N x=http://maven.apache.org/POM/4.0.0 -t -v "/x:project/x:dependencies/x:dependency[x:artifactId='common-core']/x:version")

            echo "Application Version: $app_version"
            echo "Application Parent POM Version: $parent_pom_version_app"
            echo "Application Common Core Version: $common_core_version_app"


          # echo "Matched repositories:"
          # echo "$matched_repos"
          # echo "::set-output name=repos::$matched_repos"
