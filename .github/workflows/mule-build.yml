##########################################################################
# CICD Pipeline
##########################################################################

name: Build
on:
  workflow_call:

env:
  CONFIGURATIONS_REPOSITORY: common-configurations
  SECRETS_MAPPINGFILE: _secrets.env
  GLOBAL_CONFIGURATIONFILE: _global.yml
  SECRETS_AZURE_KEYVAULT: CoveredCA-KV-Mulesoft
jobs:

  ##########################################################################
  # BUILD MULESOFT SERVICE
  ##########################################################################

  build:
    name: Build
    runs-on: ubuntu-latest

    steps:
      - name: Debug github app values
        shell: bash
        run: |
          echo " "
          echo "***********************************************"
          echo "Debug github app values"
          echo "***********************************************"
          echo "  "
          echo "  MULESOFT_GITHUBAPP_CLIENTID: ${{ secrets.MULESOFT_GITHUBAPP_CLIENTID }}"
          echo "  MULESOFT_GITHUBAPP_PRIVATEKEY: ${{ secrets.MULESOFT_GITHUBAPP_PRIVATEKEY }}"
          echo " "

      - name: Create a GitHub App installation access token
        id: app-token
        uses: peter-murray/workflow-application-token-action@v3
        with:
          application_id: ${{ secrets.MULESOFT_GITHUBAPP_CLIENTID }}
          application_private_key: ${{ secrets.MULESOFT_GITHUBAPP_PRIVATEKEY }}

      - name: Verify app token
        shell: bash
        run: |
          echo " "
          echo "***********************************************"
          echo "Verify App token"
          echo "***********************************************"
          echo "  "
          echo "  App token: ${{ steps.app-token.outputs.token }}"
          echo "github_automationbot_token=${{ steps.app-token.outputs.token }}" >> $GITHUB_ENV
          echo " "

      - name: Get secrets from Azure Key Vault
        id: secrets
        uses: CoveredCA/common-devops/packages/secrets-azure@main
        with:
          keyvault-key: ${{ env.SECRETS_AZURE_KEYVAULT}}
          azure-credentials: ${{ secrets.AZURE_CREDENTIALS }}
          secret-mapping: ${{ env.GLOBAL_CONFIGURATIONFILE}}